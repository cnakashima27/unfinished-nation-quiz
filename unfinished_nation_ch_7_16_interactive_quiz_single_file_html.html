<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chapters 7–16 Review Quiz — The Unfinished Nation (Self-Study)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#1e90ff;--muted:#9aa8b2;--good:#1f7a3a;--bad:#b02a2a}
    body{font-family:Inter,ui-sans-serif,system-ui,Helvetica,Arial;margin:0;background:linear-gradient(180deg,#071226 0%,#071b2a 100%);color:#e6eef6}
    .wrap{max-width:980px;margin:28px auto;padding:24px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02));border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    h1{margin:0 0 6px;font-size:22px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
    button, select{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.primary{background:var(--accent);color:white;border:none}
    .meta{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .card{background:rgba(255,255,255,0.02);padding:18px;border-radius:10px}
    .qnum{font-weight:600;color:var(--muted)}
    .question{font-size:18px;margin:8px 0 14px}
    .choices{display:flex;flex-direction:column;gap:10px}
    .choice{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
    .choice:hover{transform:translateY(-2px)}
    .choice.correct{outline:2px solid rgba(31,122,58,0.25);background:rgba(31,122,58,0.06)}
    .choice.incorrect{outline:2px solid rgba(176,42,42,0.18);background:rgba(176,42,42,0.04)}
    .explain{margin-top:12px;color:var(--muted);font-size:14px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
    .progress{height:10px;background:rgba(255,255,255,0.04);border-radius:6px;overflow:hidden;width:100%}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#6ad0ff)}
    .review-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .pill{padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);font-size:13px}
    .stats{display:flex;gap:12px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    @media (max-width:700px){.wrap{margin:12px;padding:14px}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Chapters 7–16 Review Quiz — The Unfinished Nation</h1>
    <p class="lead">40 multiple-choice questions covering Chapters 7–16. Mix of factual recall and analytical questions. Instant feedback, auto-grading, and per-question explanations. Use the controls to shuffle or filter by chapter.</p>

    <div class="controls">
      <button id="startBtn" class="primary">Start / Restart Quiz</button>
      <label style="display:flex;align-items:center;gap:6px"><span class="small">Filter:</span>
        <select id="chapterFilter">
          <option value="all">All chapters (7–16)</option>
          <option value="7">Chapter 7</option>
          <option value="8">Chapter 8</option>
          <option value="9">Chapter 9</option>
          <option value="10">Chapter 10</option>
          <option value="11">Chapter 11</option>
          <option value="12">Chapter 12</option>
          <option value="13">Chapter 13</option>
          <option value="14">Chapter 14</option>
          <option value="15">Chapter 15</option>
          <option value="16">Chapter 16</option>
        </select>
      </label>
      <label style="display:flex;align-items:center;gap:6px"><span class="small">Shuffle Qs</span>
        <select id="shuffleSelect"><option value="on">On</option><option value="off">Off</option></select>
      </label>
      <label style="display:flex;align-items:center;gap:6px"><span class="small">Show explanations on answer:</span>
        <select id="showExplanation"><option value="auto">Auto (recommended)</option><option value="always">Always</option><option value="never">Never</option></select>
      </label>
    </div>

    <div id="quizArea" class="card" style="display:none">
      <div class="meta">
        <div>
          <div class="qnum" id="qnum">Question 1 / 40</div>
          <div class="small" id="chapterTag">Chapter • —</div>
        </div>
        <div style="flex:1"></div>
        <div class="stats">
          <div class="small">Score: <strong id="score">0</strong></div>
          <div class="small">Answered: <strong id="answered">0</strong></div>
        </div>
      </div>

      <div>
        <div class="question" id="questionText">Question text</div>
        <div class="choices" id="choices"></div>
        <div class="explain" id="explain" style="display:none"></div>
      </div>

      <div class="footer">
        <div style="width:60%">
          <div class="progress" aria-hidden="true"><i id="progBar" style="width:0%"></i></div>
          <div class="review-list" id="reviewList"></div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="prevBtn">Prev</button>
          <button id="nextBtn">Next</button>
          <button id="finishBtn">Finish</button>
        </div>
      </div>
    </div>

    <div id="resultArea" class="card" style="display:none;margin-top:12px">
      <h3>Results</h3>
      <p class="small">Your score: <strong id="finalScore">0</strong> / <span id="totalQs">0</span> (<span id="percent">0</span>%)</p>
      <p class="small">Performance by chapter:</p>
      <div id="chapterStats" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px"></div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="retryBtn">Retry same quiz</button>
        <button id="newBtn">New quiz (reshuffle / different filter)</button>
        <button id="downloadBtn">Download answers (CSV)</button>
      </div>
    </div>

    <p class="small" style="margin-top:12px">Notes: Questions are original study questions inspired by the themes and events commonly taught in Chapters 7–16. Use the explanations to guide review; consult your textbook for deeper detail.</p>
  </div>

  <script>
  // Question bank: 40 questions across chapters 7-16. Each question: {id, chapter, q, choices[], answer: index, explain}
  const QUESTION_BANK = [
    {id:1, chapter:7, q:"Which innovation most helped transform northern manufacturing in the early 19th century?", choices:["The cotton gin","Interchangeable parts and the factory system","The steamboat","The telegraph"], answer:1, explain:"Interchangeable parts and the factory system allowed mass production and the rise of factories in the North; the telegraph and steamboat were important but less central to factory-based manufacturing."},
    {id:2, chapter:7, q:"The Market Revolution in the early 1800s refers to:", choices:["The rise of a national cash economy and expanded markets for goods","The invention of the stock market","The expansion of slavery into the North","A religious revival movement"], answer:0, explain:"The Market Revolution describes commercialization, improved transportation, and a shift toward wage labor and market exchange."},
    {id:3, chapter:8, q:"Andrew Jackson's appeal to the 'common man' was grounded primarily in:", choices:["His support for a national bank","His frontier origins and populist image","His aristocratic birth","His foreign policy successes"], answer:1, explain:"Jackson cultivated a populist identity as a self-made frontier leader, distinguishing himself from eastern elites."},
    {id:4, chapter:8, q:"Which political change expanded democracy during Jackson's era?", choices:["The elimination of property requirements for voting among white men","Universal suffrage for women","Abolition of the Electoral College","The introduction of proportional representation"], answer:0, explain:"Many states dropped property requirements, expanding white male suffrage; women and most nonwhites remained disenfranchised."},
    {id:5, chapter:8, q:"The Nullification Crisis centered on:", choices:["South Carolina's opposition to federal tariffs","Texas independence","The Bank of the United States","Native American removal"], answer:0, explain:"South Carolina, led by John C. Calhoun, claimed states could nullify federal tariffs; Jackson opposed nullification."},
    {id:6, chapter:9, q:"The main cause of the Mexican-American War (1846–1848) was:", choices:["A dispute over the Oregon border","U.S. expansionist desires and the annexation of Texas","A trade disagreement","Mexico's attempt to invade the U.S."], answer:1, explain:"U.S. expansionism (Manifest Destiny) and the annexation of Texas, plus border disputes, triggered the war."},
    {id:7, chapter:9, q:"The Wilmot Proviso attempted to:", choices:["Divide Oregon territory into free and slave zones","Ban slavery in any territory gained from Mexico","Create a separate territory for Native Americans","Establish popular sovereignty in new territories"], answer:1, explain:"The Wilmot Proviso (1846) proposed banning slavery in lands acquired from Mexico; it heightened sectional tensions."},
    {id:8, chapter:9, q:"Which development best explains the growth of sectional tensions in the 1850s?", choices:["Economic convergence between North and South","The collapse of the two-party system and disputes over slavery's expansion","A shared national consensus on slavery","A prolonged period of peace with Britain"], answer:1, explain:"Political breakdown (e.g., Whig collapse), the Kansas-Nebraska Act, and violence like "Kansas" increased sectional tensions."},
    {id:9, chapter:10, q:"The outcome of the 1860 election showed that:", choices:["There was strong national unity on slavery","The Democratic Party was unified","The North had the electoral advantage and the nation was deeply divided regionally","The South dominated national politics"], answer:2, explain:"Lincoln won with little Southern electoral support, illustrating sectional polarization and prompting secession."},
    {id:10, chapter:10, q:"The Anaconda Plan was: ", choices:["A Confederate offensive in the West","A Union strategy to blockade and control the Mississippi River","An abolitionist political platform","A Southern defensive fortification system"], answer:1, explain:"Proposed by General Winfield Scott, it aimed to suffocate the Confederacy via blockade and division."},
    {id:11, chapter:10, q:"Which battle is widely seen as the turning point of the Civil War?", choices:["First Bull Run","Antietam","Gettysburg","Shiloh"], answer:2, explain:"Gettysburg (1863) ended Lee's invasion of the North and, combined with Vicksburg, marked a turning point."},
    {id:12, chapter:10, q:"The Emancipation Proclamation (1863) did which of the following?", choices:["Freed all enslaved people in the United States immediately","Frelegally abolished slavery across the Union","Declared freedom for slaves in Confederate-held territories and reframed the war's moral stakes","Was a symbolic gesture with no legal effect"], answer:2, explain:"It declared slaves in rebelling states to be free — limited legally but important politically and diplomatically."},
    {id:13, chapter:11, q:"During Reconstruction, Radical Republicans advocated for:", choices:["A lenient reintegration of the South without protections for freedpeople","Harsh measures to restructure Southern society and full civil rights for freedpeople","Immediate withdrawal of federal troops from the South","The return of Confederate leaders to power"], answer:1, explain:"Radicals pushed for civil rights, federal protection, and political reorganization of the South."},
    {id:14, chapter:11, q:"The Black Codes were laws designed to:", choices:["Protect newly freed people's rights","Restrict the freedom of African Americans and preserve labor supply","Expand voting rights to Black men","Create separate education systems"], answer:1, explain:"Black Codes limited mobility and labor options, aiming to maintain a subordinated labor force."},
    {id:15, chapter:11, q:"Sharecropping in the postbellum South tended to:", choices:["Eliminate agricultural debt","Create another system of dependency and cyclical debt for many farmers","Rapidly industrialize the Southern economy","Grant land ownership widely to freedpeople"], answer:1, explain:"Sharecropping often trapped tenants in debt and limited economic mobility."},
    {id:16, chapter:12, q:"The Compromise of 1877 led to:", choices:["A new constitutional amendment granting women the vote","The withdrawal of federal troops from the South and the effective end of Reconstruction","The immediate enforcement of Reconstruction measures","The permanent occupation of the South by federal forces"], answer:1, explain:"The contested 1876 election led to Hayes's presidency in exchange for withdrawing troops, undermining protections for Black citizens."},
    {id:17, chapter:12, q:"The Gilded Age is best described as:", choices:["An era of egalitarian prosperity for all","A time of rapid industrial growth, conspicuous wealth, and deep social problems","A period of declining cities","A short-lived farming revival"], answer:1, explain:"Rapid industrialization and wealth accumulation coexisted with poverty, political corruption, and labor strife."},
    {id:18, chapter:12, q:"What was the primary goal of the Sherman Antitrust Act (1890)?", choices:["Regulate interstate rail rates","Break up or limit trusts and monopolies to preserve competition","Create a federal income tax","Set labor standards"], answer:1, explain:"It aimed to curb monopolies, though early enforcement was limited and uneven."},
    {id:19, chapter:13, q:"Which factor most fueled urban growth in the late 19th century?", choices:["Declining immigration","Industrial job opportunities and mass immigration","A federal program relocating people to cities","An agricultural boom in cities"], answer:1, explain:"Industry drew migrants from rural areas and millions of immigrants to cities for factory jobs."},
    {id:20, chapter:13, q:"The new immigrants of the late 19th century primarily came from:", choices:["Northern and Western Europe","Southern and Eastern Europe","Latin America","East Asia only"], answer:1, explain:"Large waves arrived from Southern and Eastern Europe (e.g., Italy, Poland), changing urban demographics."},
    {id:21, chapter:13, q:"Political machines in cities (e.g., Tammany Hall) survived largely because:", choices:["They strictly enforced anti-corruption laws","They provided services to immigrants and secured votes in exchange","They promoted nonpartisan civic reforms","They had no influence on local politics"], answer:1, explain:"Machines offered jobs, housing help, and services, exchanging patronage for votes, despite corruption."},
    {id:22, chapter:14, q:"The Knights of Labor differed from the American Federation of Labor (AFL) because:", choices:["Knights focused on skilled workers only","Knights sought broad social reforms and included unskilled workers; AFL focused on craft unions and immediate economic gains","Both were identical in strategy","AFL was founded earlier than the Knights"], answer:1, explain:"Knights advocated broad reforms and welcomed diverse workers; AFL concentrated on skilled trades and collective bargaining."},
    {id:23, chapter:14, q:"Which event symbolized the violent clash between labor and capital in 1886?", choices:["The Haymarket affair","The Pullman Strike's end","The Homestead victory for unions","The founding of the AFL"], answer:0, explain:"The Haymarket bombing in Chicago intensified public fears about radicalism and hurt labor's image."},
    {id:24, chapter:14, q:"Which invention had the most transformative effect on late-19th-century manufacturing and distribution?", choices:["The telegraph","The Bessemer process and steel production","The horse-drawn wagon","The mechanical reaper"], answer:1, explain:"Mass steel production (Bessemer method) enabled skyscrapers, rail expansion, and heavy industry growth."},
    {id:25, chapter:15, q:"The Populist movement arose mainly from the grievances of:", choices:["Urban factory workers","Western and Southern farmers suffering from debt and falling crop prices","Industrial capitalists","The professional managerial class"], answer:1, explain:"Farmers faced low prices, high shipping costs, and debt — Populists demanded monetary reform and regulation."},
    {id:26, chapter:15, q:"One of the Populists' key proposals was: ", choices:["A gold standard-only monetary policy","Free coinage of silver and inflationary monetary policy to relieve debtors","A complete return to barter","The abolition of the Interstate Commerce Commission"], answer:1, explain:"Free silver aimed to increase the money supply and ease farmers' debts; it became a major political issue."},
    {id:27, chapter:15, q:"Why did William Jennings Bryan lose the 1896 election?", choices:["Because his platform appealed more to urban industrialists than to farmers","Because he failed to build a coalition that included urban workers and his free-silver stance alarmed business and some urban voters","Because he opposed reforms","Because he did not campaign"], answer:1, explain:"Bryan energized rural voters but couldn't win major urban, industrial, and financial constituencies."},
    {id:28, chapter:15, q:"The gold standard's defense by Republicans signaled:", choices:["A commitment to inflationary policies","A pro-business, stability-first economic stance preferred by financiers and many urban voters","Immediate debt relief for farmers","The end of industrialization"], answer:1, explain:"Support for gold signaled fiscal conservatism favored by banks and business interests, helping McKinley's coalition."},
    {id:29, chapter:16, q:"By the late 19th century, American foreign policy began shifting toward:", choices:["Complete isolationism","Greater international involvement, imperial expansion, and the acquisition of overseas territories","Exclusive focus on European alliances","A moratorium on trade"], answer:1, explain:"Factors like economic interest, navalism (Mahan), and events such as the Spanish-American War pushed expansion."},
    {id:30, chapter:16, q:"The immediate cause of the Spanish-American War (1898) was:", choices:["A dispute over Alaska","The sinking of the USS Maine in Havana harbor and U.S. support for Cuban independence","A clash over Pacific islands","A tariff dispute"], answer:1, explain:"The explosion of the Maine and sensationalist journalism accelerated calls for intervention in Cuba."},
    {id:31, chapter:16, q:"Which result followed the Spanish-American War?", choices:["U.S. withdrawal from world affairs","The U.S. acquired territories like Puerto Rico, Guam, and the Philippines","The end of American industrialization","The annexation of Canada"], answer:1, explain:"The U.S. emerged as an overseas imperial power with new territories after 1898."},
    {id:32, chapter:16, q:"The Open Door Policy concerned U.S. relations with:", choices:["Latin America","China and equal commercial access","Africa","Russia"], answer:1, explain:"The Open Door aimed to keep China open to all trading nations and prevent carving into exclusive spheres."},
    {id:33, chapter:12, q:"The phrase 'Gilded Age' (coined by Twain and Warner) primarily criticizes:", choices:["The shimmering surface of prosperity that hid deep social problems and inequalities","The quality of gold in coins","Agricultural techniques of the era","The lack of technological innovation"], answer:0, explain:"The term satirized ostentatious wealth masking corruption, poverty, and social strain."},
    {id:34, chapter:13, q:"Nativists in the late 19th century were most concerned about:", choices:["The growing influence of immigrants on jobs, politics, and culture","Foreign investment in railroads","Rising farm prices","Industrial innovation"], answer:0, explain:"Nativism reacted to immigration, blaming newcomers for economic and cultural change and pushing for restrictions."},
    {id:35, chapter:14, q:"Which factor helped create national markets and speed distribution in the late 19th century?", choices:["Improved road travel only","Railroad expansion and telegraph communications","Local artisanal networks","The absence of corporations"], answer:1, explain:"Rail networks and telegraphs knitted national markets and logistics together for mass distribution."},
    {id:36, chapter:11, q:"Why did Radical Reconstruction lose political momentum in the 1870s?", choices:["Because Reconstruction goals were fully achieved","Economic concerns, Northern fatigue, corruption scandals, and rising white Southern resistance eroded support","Because the South had become uniformly Republican","Because freedpeople opposed Reconstruction"], answer:1, explain:"Economic panic, political scandals, declining Northern commitment, and violent pushback undermined Reconstruction."},
    {id:37, chapter:15, q:"How did Populists view the political power of railroads and banks?", choices:["As benign institutions necessary for growth","As predatory forces harming farmers and needing regulation or public control","As irrelevant to farm economy","As champions of small farmers"], answer:1, explain:"Populists blamed monopolistic rail rates and banking practices for farmers' troubles and sought reforms."},
    {id:38, chapter:13, q:"Settlement patterns and housing in American cities around 1900 often led to:", choices:["Improved public health universally","Overcrowding, sanitation problems, and calls for urban reform","A decline in tenement housing","The end of immigrant neighborhoods"], answer:1, explain:"Rapid urbanization led to crowded tenements, poor sanitation, and progressive-era reforms to address them."},
    {id:39, chapter:14, q:"Why did many industrialists favor 'vertical integration' or 'horizontal integration'?", choices:["To decentralize control","To increase efficiency, lower costs, and control markets—from raw materials to distribution (vertical) or to eliminate competition (horizontal)","To reduce control over production","For philanthropic reasons only"], answer:1, explain:"Integration strategies allowed businesses to manage supply chains, reduce costs, and dominate markets."},
    {id:40, chapter:16, q:"An analytical question: Which long-term economic and social changes of the Gilded Age most directly pushed the United States toward a more interventionist foreign policy at the century's end?", choices:["A decline in industrial production","The search for markets for surplus goods, expanding corporate interests abroad, and the growth of a modern navy to protect trade","Isolationist sentiment among business leaders","A reduced interest in overseas investment"], answer:1, explain:"Industrial overproduction, the need for new markets, influence of business and naval thinkers (e.g., Mahan), and social Darwinist rationales encouraged overseas expansion."}
  ];

  // App state
  let quizQs = [];
  let currentIndex = 0;
  let score = 0;
  let answeredCount = 0;
  const userAnswers = {}; // id -> {selected, correct}

  const elements = {
    startBtn: document.getElementById('startBtn'),
    chapterFilter: document.getElementById('chapterFilter'),
    shuffleSelect: document.getElementById('shuffleSelect'),
    showExplanation: document.getElementById('showExplanation'),
    quizArea: document.getElementById('quizArea'),
    qnum: document.getElementById('qnum'),
    chapterTag: document.getElementById('chapterTag'),
    questionText: document.getElementById('questionText'),
    choices: document.getElementById('choices'),
    explain: document.getElementById('explain'),
    prevBtn: document.getElementById('prevBtn'),
    nextBtn: document.getElementById('nextBtn'),
    finishBtn: document.getElementById('finishBtn'),
    progBar: document.getElementById('progBar'),
    score: document.getElementById('score'),
    answered: document.getElementById('answered'),
    reviewList: document.getElementById('reviewList'),
    resultArea: document.getElementById('resultArea'),
    finalScore: document.getElementById('finalScore'),
    totalQs: document.getElementById('totalQs'),
    percent: document.getElementById('percent'),
    chapterStats: document.getElementById('chapterStats'),
    retryBtn: document.getElementById('retryBtn'),
    newBtn: document.getElementById('newBtn'),
    downloadBtn: document.getElementById('downloadBtn')
  };

  function startQuiz() {
    // reset state
    score = 0; answeredCount = 0; currentIndex = 0; Object.keys(userAnswers).forEach(k=>delete userAnswers[k]);
    // build question pool
    const filter = elements.chapterFilter.value;
    const pool = QUESTION_BANK.filter(q=> filter==='all' ? true : String(q.chapter)===filter);
    if(pool.length===0){alert('No questions for that filter.');return}
    // shuffle if requested
    if(elements.shuffleSelect.value==='on') shuffleArray(pool);
    // choose full set (use all available)
    quizQs = pool.slice();
    // UI
    elements.quizArea.style.display='block'; elements.resultArea.style.display='none';
    renderQuestion(); updateMeta(); buildReviewList();
  }

  function renderQuestion(){
    const q = quizQs[currentIndex];
    elements.qnum.textContent = `Question ${currentIndex+1} / ${quizQs.length}`;
    elements.chapterTag.textContent = `Chapter • ${q.chapter}`;
    elements.questionText.textContent = q.q;
    elements.choices.innerHTML = '';
    elements.explain.style.display='none';
    elements.explain.textContent = '';
    q.choices.forEach((c, idx)=>{
      const btn = document.createElement('div'); btn.className='choice'; btn.tabIndex=0; btn.textContent=c;
      btn.onclick = ()=>selectAnswer(q.id, idx, btn);
      btn.onkeypress = (e)=>{ if(e.key==='Enter') selectAnswer(q.id, idx, btn)};
      // show past answer state if present
      const past = userAnswers[q.id];
      if(past){
        if(idx===past.selected){ btn.classList.add(past.correct? 'correct':'incorrect') }
        if(idx===q.answer) btn.classList.add('correct');
      }
      elements.choices.appendChild(btn);
    });
    updateProgress();
  }

  function selectAnswer(id, idx, btnElement){
    const q = quizQs[currentIndex];
    if(userAnswers[id]) return; // don't allow changing answer
    const correct = idx===q.answer;
    userAnswers[id] = {selected: idx, correct};
    answeredCount++;
    if(correct) score++;
    // mark choices
    Array.from(elements.choices.children).forEach((el,i)=>{
      el.classList.remove('correct','incorrect');
      if(i===q.answer) el.classList.add('correct');
      if(i===idx && i!==q.answer) el.classList.add('incorrect');
    });
    // show explanation according to setting
    const show = elements.showExplanation.value;
    if(show==='always' || (show==='auto')){
      elements.explain.style.display='block'; elements.explain.textContent = q.explain;
    }
    updateMeta(); buildReviewList();
  }

  function updateMeta(){
    elements.score.textContent = score;
    elements.answered.textContent = answeredCount;
  }

  function updateProgress(){
    const pct = Math.round(((currentIndex)/quizQs.length)*100);
    elements.progBar.style.width = pct+'%';
  }

  function prev(){ if(currentIndex>0){ currentIndex--; renderQuestion(); }}
  function next(){ if(currentIndex<quizQs.length-1){ currentIndex++; renderQuestion(); } }

  function finish(){
    // show results
    elements.quizArea.style.display='none'; elements.resultArea.style.display='block';
    elements.finalScore.textContent = score; elements.totalQs.textContent = quizQs.length;
    const percent = Math.round((score/quizQs.length)*100);
    elements.percent.textContent = percent;
    // chapter breakdown
    const stats = {};
    quizQs.forEach(q=>{ if(!stats[q.chapter]) stats[q.chapter]={total:0,correct:0}; stats[q.chapter].total++; const ua=userAnswers[q.id]; if(ua && ua.correct) stats[q.chapter].correct++; });
    elements.chapterStats.innerHTML='';
    Object.keys(stats).sort((a,b)=>a-b).forEach(ch=>{
      const s = stats[ch]; const pct = s.total? Math.round((s.correct/s.total)*100):0;
      const el = document.createElement('div'); el.className='pill'; el.textContent=`Ch ${ch}: ${s.correct}/${s.total} (${pct}%)`;
      elements.chapterStats.appendChild(el);
    });
  }

  function buildReviewList(){
    elements.reviewList.innerHTML='';
    quizQs.forEach((q,i)=>{
      const p = document.createElement('div'); p.className='pill';
      const ua = userAnswers[q.id];
      if(ua) p.style.borderColor = ua.correct? 'rgba(31,122,58,0.35)':'rgba(176,42,42,0.25)';
      p.textContent = `${i+1}`; p.onclick = ()=>{ currentIndex = i; elements.quizArea.style.display='block'; elements.resultArea.style.display='none'; renderQuestion(); };
      elements.reviewList.appendChild(p);
    });
  }

  function downloadCSV(){
    // create csv of qid,chapter,question,selected,correct,answer,explanation
    const rows = [['id','chapter','question','selected','selectedText','correct','answerText','explanation']];
    quizQs.forEach(q=>{
      const ua = userAnswers[q.id] || {selected:'', correct:false};
      const selText = ua.selected!=='' && ua.selected!==undefined ? q.choices[ua.selected] : '';
      rows.push([q.id,q.chapter,`"${q.q.replace(/"/g,'""')}` , ua.selected, `"${selText.replace(/"/g,'""')}",`, ua.correct, `"${q.choices[q.answer].replace(/"/g,'""')}",`, `"${q.explain.replace(/"/g,'""')}"`]);
    });
    const csv = rows.map(r=>r.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'quiz_results.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // utility: Fisher-Yates
  function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

  // wire events
  elements.startBtn.addEventListener('click', startQuiz);
  elements.prevBtn.addEventListener('click', prev);
  elements.nextBtn.addEventListener('click', next);
  elements.finishBtn.addEventListener('click', finish);
  elements.retryBtn.addEventListener('click', ()=>{ startQuiz(); });
  elements.newBtn.addEventListener('click', ()=>{ elements.startBtn.click(); });
  elements.downloadBtn.addEventListener('click', downloadCSV);

  // keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if(document.activeElement.tagName==='INPUT' || document.activeElement.tagName==='TEXTAREA') return;
    if(e.key==='ArrowLeft') prev(); if(e.key==='ArrowRight') next(); if(e.key==='s') elements.startBtn.click();
  });

  // initial hint
  </script>
</body>
</html>
